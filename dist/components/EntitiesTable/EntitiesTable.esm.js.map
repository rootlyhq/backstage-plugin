{"version":3,"file":"EntitiesTable.esm.js","sources":["../../../src/components/EntitiesTable/EntitiesTable.tsx"],"sourcesContent":["import { stringifyEntityRef } from '@backstage/catalog-model';\nimport { Progress, Table, TableColumn } from '@backstage/core-components';\nimport { configApiRef, discoveryApiRef, identityApiRef, useApi } from '@backstage/core-plugin-api';\nimport { catalogApiRef, EntityRefLink } from '@backstage/plugin-catalog-react';\nimport Link from '@material-ui/core/Link';\nimport { Alert } from '@material-ui/lab';\nimport React from 'react';\nimport { useAsync } from 'react-use';\n\nimport {\n  RootlyEntity,\n  RootlyService,\n  RootlyFunctionality,\n  RootlyTeam,\n  ROOTLY_ANNOTATION_ORG_ID,\n  RootlyApi,\n} from '@rootly/backstage-plugin-common';\nimport { useRootlyClient } from '../../api';\n\nexport const EntitiesTable = () => {\n  const catalogApi = useApi(catalogApiRef);\n  const configApi = useApi(configApiRef);\n  const discoveryApi = useApi(discoveryApiRef);\n  const identifyApi = useApi(identityApiRef);\n\n  const smallColumnStyle = {\n    width: '5%',\n    maxWidth: '5%',\n  };\n\n  const { value, loading, error } = useAsync(\n    async () => await catalogApi.getEntities(),\n  );\n\n  const fetchService = (entity: RootlyEntity) => {\n\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    const rootlyClient = useRootlyClient({discovery: discoveryApi, identify: identifyApi, config: configApi, organizationId: entity.metadata.annotations?.[ROOTLY_ANNOTATION_ORG_ID]});\n\n    const entityTriplet = stringifyEntityRef({\n      namespace: entity.metadata.namespace,\n      kind: entity.kind,\n      name: entity.metadata.name,\n    });\n    const {\n      value: response,\n      loading,\n      error,\n    } = useAsync(\n      async () =>\n        await rootlyClient.getServices({\n          filter: {\n            backstage_id: entityTriplet,\n          },\n        }),\n      [],\n    );\n    if (loading) {\n      return <Progress />;\n    } else if (error) {\n      return <div>Error</div>;\n    }\n    if (response && response.data.length > 0) {\n      entity.linkedService = response.data[0] as RootlyService;\n      return (\n        <Link\n          target=\"blank\"\n          href={RootlyApi.getServiceDetailsURL(entity.linkedService)}\n        >\n          {entity.linkedService.attributes.name}\n        </Link>\n      );\n    } \n      entity.linkedService = undefined;\n      return <div>Not Linked</div>;\n  };\n\n  const fetchFunctionality = (entity: RootlyEntity) => {\n\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    const rootlyClient = useRootlyClient({discovery: discoveryApi, identify: identifyApi, config: configApi, organizationId: entity.metadata.annotations?.[ROOTLY_ANNOTATION_ORG_ID]});\n\n    const entityTriplet = stringifyEntityRef({\n      namespace: entity.metadata.namespace,\n      kind: entity.kind,\n      name: entity.metadata.name,\n    });\n    const {\n      value: response,\n      loading,\n      error,\n    } = useAsync(\n      async () =>\n        await rootlyClient.getFunctionalities({\n          filter: {\n            backstage_id: entityTriplet,\n          },\n        }),\n      [],\n    );\n    if (loading) {\n      return <Progress />;\n    } else if (error) {\n      return <div>Error</div>;\n    }\n    if (response && response.data.length > 0) {\n      entity.linkedFunctionality = response.data[0] as RootlyFunctionality;\n      return (\n        <Link\n          target=\"blank\"\n          href={RootlyApi.getFunctionalityDetailsURL(entity.linkedFunctionality)}\n        >\n          {entity.linkedFunctionality.attributes.name}\n        </Link>\n      );\n    } \n      entity.linkedFunctionality = undefined;\n      return <div>Not Linked</div>;\n  };\n\n  const fetchTeam = (entity: RootlyEntity) => {\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    const rootlyClient = useRootlyClient({discovery: discoveryApi, identify: identifyApi, config: configApi, organizationId: entity.metadata.annotations?.[ROOTLY_ANNOTATION_ORG_ID]});\n\n    const entityTriplet = stringifyEntityRef({\n      namespace: entity.metadata.namespace,\n      kind: entity.kind,\n      name: entity.metadata.name,\n    });\n    const {\n      value: response,\n      loading,\n      error,\n    } = useAsync(\n      async () =>\n        await rootlyClient.getTeams({\n          filter: {\n            backstage_id: entityTriplet,\n          },\n        }),\n      [],\n    );\n    if (loading) {\n      return <Progress />;\n    } else if (error) {\n      return <div>Error</div>;\n    }\n    if (response && response.data.length > 0) {\n      entity.linkedTeam = response.data[0] as RootlyTeam;\n      return (\n        <Link\n          target=\"blank\"\n          href={RootlyApi.getTeamDetailsURL(entity.linkedTeam)}\n        >\n          {entity.linkedTeam.attributes.name}\n        </Link>\n      );\n    } \n      entity.linkedTeam = undefined;\n      return <div>Not Linked</div>;\n  };\n\n  const columns: TableColumn<RootlyEntity>[] = [\n    {\n      title: 'Kind',\n      field: 'kind',\n      highlight: true,\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n    },\n    {\n      title: 'Name',\n      field: 'metadata.name',\n      highlight: true,\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n      render: rowData => {\n        return <EntityRefLink entityRef={rowData} />;\n      },\n    },\n    {\n      title: 'Description',\n      field: 'metadata.description',\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n    },\n    {\n      title: 'Rootly Service',\n      field: 'linked',\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n      render: rowData => {\n        return fetchService(rowData);\n      },\n    },\n    {\n      title: 'Rootly Functionality',\n      field: 'linked',\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n      render: rowData => {\n        return fetchFunctionality(rowData);\n      },\n    },\n    {\n      title: 'Rootly Team',\n      field: 'linked',\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n      render: rowData => {\n        return fetchTeam(rowData);\n      },\n    },\n  ];\n\n  if (error) {\n    return <Alert severity=\"error\">{error.message}</Alert>;\n  }\n\n  const data = value\n    ? value.items.map(entity => {\n        const entityTriplet = stringifyEntityRef({\n          namespace: entity.metadata.namespace,\n          kind: entity.kind,\n          name: entity.metadata.name,\n        });\n        return { ...entity, id: entityTriplet, linkedService: undefined, linkedFunctionality: undefined, linkedTeam: undefined};\n      })\n    : [];\n\n  return (\n    <Table\n      isLoading={loading}\n      options={{\n        sorting: true,\n        search: true,\n        paging: true,\n        actionsColumnIndex: -1,\n        pageSize: 25,\n        pageSizeOptions: [25, 50, 100, 150, 200],\n        padding: 'dense',\n      }}\n      localization={{ header: { actions: undefined } }}\n      columns={columns}\n      data={data}\n    />\n  );\n};\n"],"names":["loading","error"],"mappings":"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"}