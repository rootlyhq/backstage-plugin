{"version":3,"file":"EntitiesTable.esm.js","sources":["../../../src/components/EntitiesTable/EntitiesTable.tsx"],"sourcesContent":["import { stringifyEntityRef } from '@backstage/catalog-model';\nimport { Progress, Table, TableColumn } from '@backstage/core-components';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { catalogApiRef, EntityRefLink } from '@backstage/plugin-catalog-react';\nimport Link from '@material-ui/core/Link';\nimport { Alert } from '@material-ui/lab';\nimport React from 'react';\nimport { useAsync } from 'react-use';\n\nimport {\n  RootlyEntity,\n  RootlyService,\n  RootlyFunctionality,\n  RootlyTeam,\n  ROOTLY_ANNOTATION_ORG_ID,\n  RootlyApi,\n} from '@rootly/backstage-plugin-common';\nimport { useRootlyClient } from '../../api';\n\nexport const EntitiesTable = () => {\n  const catalogApi = useApi(catalogApiRef);\n\n  const smallColumnStyle = {\n    width: '5%',\n    maxWidth: '5%',\n  };\n\n  const { value, loading, error } = useAsync(\n    async () => await catalogApi.getEntities(),\n  );\n\n  const fetchService = (entity: RootlyEntity) => {\n\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    const rootlyClient = useRootlyClient({organizationId: entity.metadata.annotations?.[ROOTLY_ANNOTATION_ORG_ID]});\n\n    const entityTriplet = stringifyEntityRef({\n      namespace: entity.metadata.namespace,\n      kind: entity.kind,\n      name: entity.metadata.name,\n    });\n    const {\n      value: response,\n      loading,\n      error,\n    } = useAsync(\n      async () =>\n        await rootlyClient.getServices({\n          filter: {\n            backstage_id: entityTriplet,\n          },\n        }),\n      [],\n    );\n    if (loading) {\n      return <Progress />;\n    } else if (error) {\n      return <div>Error</div>;\n    }\n    if (response && response.data.length > 0) {\n      entity.linkedService = response.data[0] as RootlyService;\n      return (\n        <Link\n          target=\"blank\"\n          href={RootlyApi.getServiceDetailsURL(entity.linkedService)}\n        >\n          {entity.linkedService.attributes.name}\n        </Link>\n      );\n    } \n      entity.linkedService = undefined;\n      return <div>Not Linked</div>;\n  };\n\n  const fetchFunctionality = (entity: RootlyEntity) => {\n\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    const rootlyClient = useRootlyClient({organizationId: entity.metadata.annotations?.[ROOTLY_ANNOTATION_ORG_ID]});\n\n    const entityTriplet = stringifyEntityRef({\n      namespace: entity.metadata.namespace,\n      kind: entity.kind,\n      name: entity.metadata.name,\n    });\n    const {\n      value: response,\n      loading,\n      error,\n    } = useAsync(\n      async () =>\n        await rootlyClient.getFunctionalities({\n          filter: {\n            backstage_id: entityTriplet,\n          },\n        }),\n      [],\n    );\n    if (loading) {\n      return <Progress />;\n    } else if (error) {\n      return <div>Error</div>;\n    }\n    if (response && response.data.length > 0) {\n      entity.linkedFunctionality = response.data[0] as RootlyFunctionality;\n      return (\n        <Link\n          target=\"blank\"\n          href={RootlyApi.getFunctionalityDetailsURL(entity.linkedFunctionality)}\n        >\n          {entity.linkedFunctionality.attributes.name}\n        </Link>\n      );\n    } \n      entity.linkedFunctionality = undefined;\n      return <div>Not Linked</div>;\n  };\n\n  const fetchTeam = (entity: RootlyEntity) => {\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    const rootlyClient = useRootlyClient({ organizationId: entity.metadata.annotations?.[ROOTLY_ANNOTATION_ORG_ID]});\n\n    const entityTriplet = stringifyEntityRef({\n      namespace: entity.metadata.namespace,\n      kind: entity.kind,\n      name: entity.metadata.name,\n    });\n    const {\n      value: response,\n      loading,\n      error,\n    } = useAsync(\n      async () =>\n        await rootlyClient.getTeams({\n          filter: {\n            backstage_id: entityTriplet,\n          },\n        }),\n      [],\n    );\n    if (loading) {\n      return <Progress />;\n    } else if (error) {\n      return <div>Error</div>;\n    }\n    if (response && response.data.length > 0) {\n      entity.linkedTeam = response.data[0] as RootlyTeam;\n      return (\n        <Link\n          target=\"blank\"\n          href={RootlyApi.getTeamDetailsURL(entity.linkedTeam)}\n        >\n          {entity.linkedTeam.attributes.name}\n        </Link>\n      );\n    } \n      entity.linkedTeam = undefined;\n      return <div>Not Linked</div>;\n  };\n\n  const columns: TableColumn<RootlyEntity>[] = [\n    {\n      title: 'Kind',\n      field: 'kind',\n      highlight: true,\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n    },\n    {\n      title: 'Name',\n      field: 'metadata.name',\n      highlight: true,\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n      render: rowData => {\n        return <EntityRefLink entityRef={rowData} />;\n      },\n    },\n    {\n      title: 'Description',\n      field: 'metadata.description',\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n    },\n    {\n      title: 'Rootly Service',\n      field: 'linked',\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n      render: rowData => {\n        return fetchService(rowData);\n      },\n    },\n    {\n      title: 'Rootly Functionality',\n      field: 'linked',\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n      render: rowData => {\n        return fetchFunctionality(rowData);\n      },\n    },\n    {\n      title: 'Rootly Team',\n      field: 'linked',\n      cellStyle: smallColumnStyle,\n      headerStyle: smallColumnStyle,\n      render: rowData => {\n        return fetchTeam(rowData);\n      },\n    },\n  ];\n\n  if (error) {\n    return <Alert severity=\"error\">{error.message}</Alert>;\n  }\n\n  const data = value\n    ? value.items.map(entity => {\n        const entityTriplet = stringifyEntityRef({\n          namespace: entity.metadata.namespace,\n          kind: entity.kind,\n          name: entity.metadata.name,\n        });\n        return { ...entity, id: entityTriplet, rootlyKind: undefined, linkedService: undefined, linkedFunctionality: undefined, linkedTeam: undefined};\n      })\n    : [];\n\n  return (\n    <Table\n      isLoading={loading}\n      options={{\n        sorting: true,\n        search: true,\n        paging: true,\n        actionsColumnIndex: -1,\n        pageSize: 25,\n        pageSizeOptions: [25, 50, 100, 150, 200],\n        padding: 'dense',\n      }}\n      localization={{ header: { actions: undefined } }}\n      columns={columns}\n      data={data}\n    />\n  );\n};\n"],"names":["loading","error"],"mappings":"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"}