{"version":3,"file":"api.esm.js","sources":["../src/api.ts"],"sourcesContent":["import {\n  createApiRef,\n  ConfigApi,\n  configApiRef,\n  IdentityApi,\n  identityApiRef,\n  DiscoveryApi,\n  discoveryApiRef,\n  useApi,\n  useApiHolder,\n} from \"@backstage/core-plugin-api\";\nimport { RootlyApi } from \"@rootly/backstage-plugin-common\";\n\ntype RootlyClientOptions = {\n  organizationId?: string;\n}\n\nexport type RootlyApiRef = {\n  getClient(options: RootlyClientOptions): RootlyApi;\n}\n\nexport const rootlyApiRef = createApiRef<RootlyApiRef>({\n  id: \"rootly\",\n});\n\ntype RootlyApiOptions = {\n  config: ConfigApi;\n  identity: IdentityApi;\n  discovery: DiscoveryApi;\n};\n\nexport class RootlyApiImpl implements RootlyApiRef {\n  #config: ConfigApi;\n  #identity: IdentityApi;\n  #discovery: DiscoveryApi;\n\n  private constructor(options: RootlyApiOptions) {\n    const { config, discovery, identity } = options;\n    this.#config = config;\n    this.#discovery = discovery;\n    this.#identity = identity;\n  }\n\n  static fromOptions(options: RootlyApiOptions) {\n    return new RootlyApiImpl(options);\n  }\n\n  getClient(options: RootlyClientOptions) {\n    const { organizationId } = options;\n\n    const configKeys = this.#config.getConfig(\"rootly\").keys();\n\n    let apiProxyPath = this.#config.getOptionalString(\n      `rootly.${configKeys.at(0)}.proxyPath`\n    );\n\n    if (organizationId) {\n      apiProxyPath = this.#config.getOptionalString(\n        `rootly.${organizationId}.proxyPath`\n      );\n    } else if (configKeys.length > 1) {\n      let defaultOrgId = this.#config.getConfig(\"rootly\").keys().at(0);\n      for (const orgId of this.#config.getConfig(\"rootly\").keys()) {\n        if (this.#config.getOptionalBoolean(`rootly.${orgId}.isDefault`)) {\n          defaultOrgId = orgId;\n          break;\n        }\n      }\n      apiProxyPath = this.#config.getOptionalString(\n        `rootly.${defaultOrgId}.proxyPath`\n      );\n    }\n\n    return new RootlyApi({\n      apiProxyPath,\n      apiProxyUrl: this.#discovery.getBaseUrl(\"proxy\"),\n      apiToken: this.#identity.getCredentials(),\n    });\n  }\n}\n\nexport const useRootlyClient = ({\n  organizationId,\n}: {\n  organizationId?: string;\n}) => {\n  const config = useApi(configApiRef);\n  const identity = useApi(identityApiRef);\n  const discovery = useApi(discoveryApiRef);\n  const apis = useApiHolder();\n  const rootlyApi = apis.get(rootlyApiRef) || RootlyApiImpl.fromOptions({ config, identity, discovery });\n    return rootlyApi.getClient({ organizationId });\n};\n"],"names":[],"mappings":";;;AAqBO,MAAM,eAAe,YAAA,CAA2B;AAAA,EACrD,EAAA,EAAI;AACN,CAAC;AAQM,MAAM,aAAA,CAAsC;AAAA,EACjD,OAAA;AAAA,EACA,SAAA;AAAA,EACA,UAAA;AAAA,EAEQ,YAAY,OAAA,EAA2B;AAC7C,IAAA,MAAM,EAAE,MAAA,EAAQ,SAAA,EAAW,QAAA,EAAS,GAAI,OAAA;AACxC,IAAA,IAAA,CAAK,OAAA,GAAU,MAAA;AACf,IAAA,IAAA,CAAK,UAAA,GAAa,SAAA;AAClB,IAAA,IAAA,CAAK,SAAA,GAAY,QAAA;AAAA,EACnB;AAAA,EAEA,OAAO,YAAY,OAAA,EAA2B;AAC5C,IAAA,OAAO,IAAI,cAAc,OAAO,CAAA;AAAA,EAClC;AAAA,EAEA,UAAU,OAAA,EAA8B;AACtC,IAAA,MAAM,EAAE,gBAAe,GAAI,OAAA;AAE3B,IAAA,MAAM,aAAa,IAAA,CAAK,OAAA,CAAQ,SAAA,CAAU,QAAQ,EAAE,IAAA,EAAK;AAEzD,IAAA,IAAI,YAAA,GAAe,KAAK,OAAA,CAAQ,iBAAA;AAAA,MAC9B,CAAA,OAAA,EAAU,UAAA,CAAW,EAAA,CAAG,CAAC,CAAC,CAAA,UAAA;AAAA,KAC5B;AAEA,IAAA,IAAI,cAAA,EAAgB;AAClB,MAAA,YAAA,GAAe,KAAK,OAAA,CAAQ,iBAAA;AAAA,QAC1B,UAAU,cAAc,CAAA,UAAA;AAAA,OAC1B;AAAA,IACF,CAAA,MAAA,IAAW,UAAA,CAAW,MAAA,GAAS,CAAA,EAAG;AAChC,MAAA,IAAI,YAAA,GAAe,KAAK,OAAA,CAAQ,SAAA,CAAU,QAAQ,CAAA,CAAE,IAAA,EAAK,CAAE,EAAA,CAAG,CAAC,CAAA;AAC/D,MAAA,KAAA,MAAW,SAAS,IAAA,CAAK,OAAA,CAAQ,UAAU,QAAQ,CAAA,CAAE,MAAK,EAAG;AAC3D,QAAA,IAAI,KAAK,OAAA,CAAQ,kBAAA,CAAmB,CAAA,OAAA,EAAU,KAAK,YAAY,CAAA,EAAG;AAChE,UAAA,YAAA,GAAe,KAAA;AACf,UAAA;AAAA,QACF;AAAA,MACF;AACA,MAAA,YAAA,GAAe,KAAK,OAAA,CAAQ,iBAAA;AAAA,QAC1B,UAAU,YAAY,CAAA,UAAA;AAAA,OACxB;AAAA,IACF;AAEA,IAAA,OAAO,IAAI,SAAA,CAAU;AAAA,MACnB,YAAA;AAAA,MACA,WAAA,EAAa,IAAA,CAAK,UAAA,CAAW,UAAA,CAAW,OAAO,CAAA;AAAA,MAC/C,QAAA,EAAU,IAAA,CAAK,SAAA,CAAU,cAAA;AAAe,KACzC,CAAA;AAAA,EACH;AACF;AAEO,MAAM,kBAAkB,CAAC;AAAA,EAC9B;AACF,CAAA,KAEM;AACJ,EAAA,MAAM,MAAA,GAAS,OAAO,YAAY,CAAA;AAClC,EAAA,MAAM,QAAA,GAAW,OAAO,cAAc,CAAA;AACtC,EAAA,MAAM,SAAA,GAAY,OAAO,eAAe,CAAA;AACxC,EAAA,MAAM,OAAO,YAAA,EAAa;AAC1B,EAAA,MAAM,SAAA,GAAY,IAAA,CAAK,GAAA,CAAI,YAAY,CAAA,IAAK,aAAA,CAAc,WAAA,CAAY,EAAE,MAAA,EAAQ,QAAA,EAAU,SAAA,EAAW,CAAA;AACnG,EAAA,OAAO,SAAA,CAAU,SAAA,CAAU,EAAE,cAAA,EAAgB,CAAA;AACjD;;;;"}